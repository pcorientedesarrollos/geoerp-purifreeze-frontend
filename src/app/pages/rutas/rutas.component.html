<mat-card class="form-card">
  <mat-card-header>
    <mat-card-title>Crear Nueva Ruta</mat-card-title>
    <mat-card-subtitle>Asigna los datos generales y selecciona los servicios que conformarán la ruta.</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- 1. Datos de la Ruta (Encabezado) -->
    <h3 class="section-title">1. Datos Generales de la Ruta</h3>
    <form [formGroup]="rutaForm" class="header-form">
      <mat-form-field appearance="outline">
        <mat-label>Operador</mat-label>
        <mat-select formControlName="idUsuario" required>
          @for(op of operadores(); track op.idUsuario){
            <mat-option [value]="op.idUsuario">{{ op.usuario }}</mat-option>
          }
        </mat-select>
        @if (rutaForm.get('idUsuario')?.hasError('required')) {
          <mat-error>El operador es requerido.</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Unidad de Transporte</mat-label>
        <mat-select formControlName="idUnidadTransporte" required>
          @for(unidad of unidades(); track unidad.idUnidadTransporte){
            <mat-option [value]="unidad.idUnidadTransporte">{{ unidad.placaUnidad }}</mat-option>
          }
        </mat-select>
        @if (rutaForm.get('idUnidadTransporte')?.hasError('required')) {
          <mat-error>La unidad es requerida.</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Kilometraje Inicial</mat-label>
        <input matInput type="number" formControlName="kmInicial" required>
        @if (rutaForm.get('kmInicial')?.hasError('required')) {
          <mat-error>El KM inicial es requerido.</mat-error>
        }
      </mat-form-field>
    </form>

    <mat-divider class="section-divider"></mat-divider>

    <!-- 2. Tabla de Servicios Disponibles -->
    <h3 class="section-title">2. Seleccionar Servicios para la Ruta</h3>

    @if (isLoading()) {
      <div class="loading-container">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        <p>Cargando servicios disponibles...</p>
      </div>
    } @else {
      <mat-form-field appearance="outline">
        <mat-label>Buscar en servicios...</mat-label>
        <input matInput [formControl]="filterControl" placeholder="Ej: Cliente, equipo, tipo...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <div class="table-container mat-elevation-z4">
        <table mat-table [dataSource]="serviciosDisponibles" matSort>
          <!-- Columnas -->
          <ng-container matColumnDef="select"><th mat-header-cell *matHeaderCellDef><mat-checkbox (change)="$event ? toggleAllRows() : null" [checked]="selection.hasValue() && isAllSelected()" [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="checkboxLabel()"></mat-checkbox></th><td mat-cell *matCellDef="let row"><mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)" [aria-label]="checkboxLabel(row)"></mat-checkbox></td></ng-container>
          <ng-container matColumnDef="nombreComercio"><th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th><td mat-cell *matCellDef="let element"> {{element.nombreComercio}} </td></ng-container>
          <ng-container matColumnDef="nombreEquipo"><th mat-header-cell *matHeaderCellDef mat-sort-header> Equipo </th><td mat-cell *matCellDef="let element"> {{element.nombreEquipo}} </td></ng-container>
          <ng-container matColumnDef="tipoServicio"><th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo de Servicio </th><td mat-cell *matCellDef="let element"> {{element.tipoServicio}} </td></ng-container>
          <ng-container matColumnDef="fechaServicio"><th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha Servicio </th><td mat-cell *matCellDef="let element"> {{element.fechaServicio | date:'dd/MM/yyyy'}} </td></ng-container>

          <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
          <tr mat-row *matRowDef="let row; columns: columnasTabla;"></tr>
          <tr class="mat-row" *matNoDataRow><td class="mat-cell" colspan="5">No se encontraron servicios que coincidan con el filtro.</td></tr>
        </table>
        <mat-paginator [pageSizeOptions]="[10, 25, 100]" showFirstLastButtons></mat-paginator>
      </div>
    }
  </mat-card-content>

  <mat-card-actions class="form-actions">
    <button mat-stroked-button type="button" (click)="cancelar()">Cancelar</button>
    <button mat-raised-button color="primary" (click)="guardarRuta()" [disabled]="rutaForm.invalid || selection.isEmpty() || isSaving()">
      @if (isSaving()) {
        <span>Guardando...</span>
        <mat-progress-spinner mode="indeterminate" diameter="20" style="margin-left: 8px;"></mat-progress-spinner>
      } @else {
        <!-- CORRECCIÓN: Envolver los elementos en un ng-container -->
        <ng-container>
          <mat-icon>save</mat-icon>
          <span>Guardar Ruta ({{selection.selected.length}} servicios)</span>
        </ng-container>
      }
    </button>
  </mat-card-actions>
</mat-card>