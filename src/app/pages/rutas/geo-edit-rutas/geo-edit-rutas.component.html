<mat-card class="form-card">
  <mat-card-header>
    <mat-card-title>
      Editar Ruta #{{ rutaActual?.idRuta }}
    </mat-card-title>
    <mat-card-subtitle>Modifica los datos generales y gestiona los servicios asignados.</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content *ngIf="!isLoading; else loadingTemplate">
    <!-- 1. Formulario de Datos Generales -->
    <h3 class="section-title">1. Datos Generales de la Ruta</h3>
    <form [formGroup]="rutaForm" class="header-form">
      <mat-form-field appearance="outline">
        <mat-label>Operador</mat-label>
        <mat-select formControlName="idUsuario" required>
          <mat-option *ngFor="let op of operadores" [value]="op.idUsuario">{{ op.usuario }}</mat-option>
        </mat-select>
        <mat-error *ngIf="rutaForm.get('idUsuario')?.hasError('required')">El operador es requerido.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Unidad de Transporte</mat-label>
        <mat-select formControlName="idUnidadTransporte" required>
          <mat-option *ngFor="let unidad of unidades" [value]="unidad.idUnidadTransporte">{{ unidad.placaUnidad }} - {{ unidad.nombreUnidad }}</mat-option>
        </mat-select>
        <mat-error *ngIf="rutaForm.get('idUnidadTransporte')?.hasError('required')">La unidad es requerida.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Kilometraje Inicial</mat-label>
        <input matInput type="number" formControlName="kmInicial" required>
        <mat-error *ngIf="rutaForm.get('kmInicial')?.hasError('required')">El KM inicial es requerido.</mat-error>
      </mat-form-field>

      <div class="header-actions">
        <button mat-flat-button color="primary" (click)="guardarEncabezado()" [disabled]="rutaForm.invalid || isSaving">
          <mat-icon>save</mat-icon>
          <span>Guardar Cambios</span>
        </button>
      </div>
    </form>

    <mat-divider class="section-divider"></mat-divider>

    <!-- 2. Sección de Servicios Asignados -->
    <div class="details-header">
      <h3 class="section-title">2. Servicios Asignados ({{ detallesDataSource.data.length }})</h3>
      <button mat-stroked-button color="accent" (click)="abrirModalAgregarServicios()">
        <mat-icon>add</mat-icon>
        <span>Agregar Servicios</span>
      </button>
    </div>

    <div class="table-container mat-elevation-z4">
      <table mat-table [dataSource]="detallesDataSource">

        <ng-container matColumnDef="folioContrato">
          <th mat-header-cell *matHeaderCellDef> Folio Contrato </th>
          <td mat-cell *matCellDef="let detalle"> {{ detalle.idContrato }} </td>
        </ng-container>

        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef> Cliente </th>
          <td mat-cell *matCellDef="let detalle"> {{ detalle.nombreComercio }} </td>
        </ng-container>

        <ng-container matColumnDef="equipo">
          <th mat-header-cell *matHeaderCellDef> Equipo </th>
          <td mat-cell *matCellDef="let detalle"> {{ detalle.nombreEquipo }} </td>
        </ng-container>

        <ng-container matColumnDef="tipoServicio">
          <th mat-header-cell *matHeaderCellDef> Tipo de Servicio </th>
          <td mat-cell *matCellDef="let detalle"> {{ detalle.tipoServicio }} </td>
        </ng-container>

        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef> Fecha/Hora </th>
          <td mat-cell *matCellDef="let detalle"> {{ detalle.fechaServicio | date:'dd/MM/yyyy' }} {{ detalle.hora }}</td>
        </ng-container>

        <!-- Columna de Status (MODIFICADA) -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Estado del Servicio </th>
          <td mat-cell *matCellDef="let detalle">
            <mat-form-field appearance="outline" class="status-select">
              <mat-select [value]="detalle.status" (selectionChange)="cambiarStatusDetalle(detalle, $event.value)">
                <!-- El bucle ahora usa la lista dinámica de estados -->
                <mat-option *ngFor="let status of statusList" [value]="status.idStatus">
                  {{ status.status }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="actions-header"> Acciones </th>
          <td mat-cell *matCellDef="let detalle" class="actions-cell">
            <button mat-icon-button color="warn" matTooltip="Quitar servicio de la ruta"
                    (click)="eliminarDetalle(detalle.idRutaDetalle, detalle.nombreComercio)">
              <mat-icon>delete_forever</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            Esta ruta no tiene servicios asignados.
          </td>
        </tr>
      </table>
    </div>
  </mat-card-content>

  <!-- Template de Carga -->
  <ng-template #loadingTemplate>
    <div class="loading-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      <p>Cargando datos de la ruta...</p>
    </div>
  </ng-template>

  <mat-card-actions class="form-actions">
    <button mat-stroked-button type="button" (click)="cancelar()">Volver a la Lista</button>
    <mat-progress-spinner *ngIf="isSaving" mode="indeterminate" diameter="20"></mat-progress-spinner>
  </mat-card-actions>
</mat-card>