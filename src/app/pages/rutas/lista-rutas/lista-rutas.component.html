<!-- Tarjeta principal que contiene toda la página -->
<mat-card class="page-card">
  <!-- Encabezado con título y botón de acción -->
  <header class="page-header">
    <mat-card-title>
      <mat-icon>alt_route</mat-icon>
      <h1>Listado de Rutas</h1>
    </mat-card-title>
    <span class="spacer"></span>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="crearRuta()">
        <mat-icon>add</mat-icon>
        <span>Crear Nueva Ruta</span>
      </button>
    </div>
  </header>

  <!-- Contenido principal: filtro y tabla -->
  <mat-card-content>
    @if (isLoading) {
      <div class="loading-container">
        <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
      </div>
    } @else {
      <!-- Campo de filtro -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Buscar en rutas...</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Ej: Operador, ID, Estado...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Contenedor de la tabla para el scroll -->
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort>

          <!-- Columna ID -->
          <ng-container matColumnDef="idRuta">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> #Ruta</th>
            <td mat-cell *matCellDef="let ruta"> {{ruta.idRuta}} </td>
          </ng-container>

          <!-- Columna Operador -->
          <ng-container matColumnDef="operador">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Operador </th>
            <td mat-cell *matCellDef="let ruta"> {{ruta.usuario?.usuario || 'N/A'}} </td>
          </ng-container>

          <!-- Columna Unidad -->
          <ng-container matColumnDef="unidad">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Unidad </th>
            <td mat-cell *matCellDef="let ruta"> {{ruta.unidadTransporte?.nombreUnidad || 'N/A'}} </td>
          </ng-container>
          
          <!-- Columna Fecha -->
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha Finalizacion </th>
            <td mat-cell *matCellDef="let ruta"> {{ruta.fechaHora | date:'dd/MM/yyyy HH:mm'}} </td>
          </ng-container>

          <!-- Columna Estado -->
          <ng-container matColumnDef="statusRuta">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
            <td mat-cell *matCellDef="let ruta"> {{ruta.statusRuta}} </td>
          </ng-container>

          <!-- Columna Clientes -->
          <ng-container matColumnDef="clientes">
            <th mat-header-cell *matHeaderCellDef> Clientes </th>
            <td mat-cell *matCellDef="let ruta">
              <button mat-stroked-button (click)="verDetalles(ruta.detalles, detallesModal)">
                Ver ({{ruta.detalles?.length || 0}})
              </button>
            </td>
          </ng-container>
          
          <!-- Columna Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let ruta">
              <button mat-icon-button color="primary" matTooltip="Editar Ruta"
                      [disabled]="ruta.statusRuta === 'ELIMINADA'"
                      (click)="editarRuta(ruta.idRuta)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Eliminar Ruta"
                      [disabled]="ruta.statusRuta === 'ELIMINADA'"
                      (click)="eliminarRuta(ruta)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Definición de filas -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [ngClass]="{'ruta-eliminada': row.statusRuta === 'ELIMINADA'}">
          </tr>
        </table>
      </div>

      <!-- Paginador -->
      <mat-paginator [pageSizeOptions]="[5, 10, 25, 50]" showFirstLastButtons></mat-paginator>
    }
  </mat-card-content>
</mat-card>

<!-- Template para el Modal de Detalles -->
<ng-template #detallesModal let-data>
  <h2 mat-dialog-title>
    <mat-icon>people</mat-icon>
    <span>Clientes en la Ruta</span>
  </h2>
  <mat-dialog-content class="mat-typography">
    @if (!data.detalles || data.detalles.length === 0) {
      <div class="no-data-message">
        <mat-icon>info</mat-icon>
        <p>Esta ruta no tiene servicios ni clientes asignados.</p>
      </div>
    } @else {
      @for (detalle of data.detalles; track detalle.idRutaDetalle; let i = $index) {
        <mat-card class="detalle-card">
          <mat-card-header>
            <div mat-card-avatar class="detalle-avatar">{{ i + 1 }}</div>
            <mat-card-title>{{ detalle.nombreComercio }}</mat-card-title>
            <mat-card-subtitle>{{ detalle.tipoServicio }}</mat-card-subtitle>

          </mat-card-header>
          <mat-card-content>
            <div class="detalle-info-row">
              <mat-icon>build</mat-icon>
              <span><strong>Equipo:</strong> {{ detalle.nombreEquipo }}</span>
            </div>
            <div class="detalle-info-row">
              <mat-icon>calendar_today</mat-icon>
              <span><strong>Fecha del servicio:</strong> {{ detalle.fechaServicio | date:'dd/MM/yyyy' }} a las {{ detalle.hora }}</span>
            </div>
            <div class="detalle-info-row">
            <mat-icon>visibility</mat-icon>     
            <span><strong>Observaciones del servicio:</strong> {{ detalle.observacionesServicio}}</span>
            </div>

          </mat-card-content>
        </mat-card>
      }
    }
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close>Cerrar</button>
  </mat-dialog-actions>
</ng-template>