<!-- COPIA Y PEGA ESTE CONTENIDO COMPLETO EN TU ARCHIVO .HTML -->

<mat-card class="recorrido-page-card">
  <!-- La sección superior del monitor (título, filtros, mapa) se mantiene sin cambios -->
  <mat-card-header>
    <mat-card-title>Monitor de Rutas y Recorridos</mat-card-title>
    <mat-card-subtitle>Filtra y selecciona una ruta para analizar su trazado y estado.</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Controles y Mapa (se mantienen igual) -->
    <h3 class="section-title">Controles de Visualización</h3>
    <div class="controls-container">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Buscar Ruta</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput [formControl]="filterControl" placeholder="ID, Operador, Unidad...">
        @if (filterControl.value) {
          <button mat-icon-button matSuffix (click)="limpiarFiltro()" aria-label="Limpiar filtro">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>

      <button mat-stroked-button color="primary" (click)="toggleMapa()">
        <mat-icon>{{ mapaVisible ? "visibility_off" : "map" }}</mat-icon>
        <span>{{ mapaVisible ? "Ocultar Mapa" : "Mostrar Mapa" }}</span>
      </button>
    </div>

    @if (selectedRuta && selectedRuta.status) {
      <div class="top-panel-container">
        <div class="details-panel">
          <div class="details-header">
            <h4>Detalles de la Ruta #{{ selectedRuta.idRuta }}</h4>
            @if(selectedRuta.status.status.toLowerCase() === 'en curso') {
              <span class="live-indicator">EN VIVO</span>
            }
          </div>
          
          @if (selectedRuta.status.status.toLowerCase() === 'finalizada') {
            <div class="summary-content">
              <div class="summary-item" matTooltip="Distancia total"><mat-icon>linear_scale</mat-icon><div class="summary-text"><span>{{ selectedRuta.distanciaTotalKm | number : "1.2-2" }} km</span><label>Distancia</label></div></div>
              <div class="summary-item" matTooltip="Duración del viaje"><mat-icon>timer</mat-icon><div class="summary-text"><span>{{ formatarDuracion(selectedRuta.duracionMinutos) }}</span><label>Duración</label></div></div>
              <div class="summary-item" matTooltip="Consumo estimado"><mat-icon>local_gas_station</mat-icon><div class="summary-text"><span>{{ selectedRuta.consumoEstimadoLitros | number : "1.2-2" }} L</span><label>Consumo</label></div></div>
            </div>
          } @else {
            <p class="details-placeholder">Las estadísticas de la ruta se mostrarán aquí una vez que finalice.</p>
          }
        </div>

        <div class="legend-panel">
          <h5 class="legend-title">Leyenda del Mapa</h5>
          <div class="map-legend">
            <div class="legend-item"><span class="color-box real-route"></span>Recorrido Real (GPS)</div>
            <div class="legend-item"><span class="color-box optimal-route"></span>Ruta Óptima (Sugerida)</div>
            <div class="legend-item"><mat-icon class="legend-icon visited">storefront</mat-icon>Cliente Visitado</div>
            <div class="legend-item"><mat-icon class="legend-icon pending">storefront</mat-icon>Cliente Pendiente</div>
            <div class="legend-item"><mat-icon class="legend-icon start">flag</mat-icon>Punto de Partida</div>
            <div class="legend-item"><mat-icon class="legend-icon end">local_shipping</mat-icon>Última Posición</div>
          </div>
        </div>
      </div>
    }

    <div class="map-container" [@slideInOut]="mapaVisible ? 'in' : 'out'">
      <div class="map-wrapper">
        @if (isLoadingData && !dataSource.data.length) {
          <div class="map-overlay-message"><mat-spinner diameter="50"></mat-spinner><p>Cargando datos iniciales...</p></div>
        } @else if (isLoadingData && selectedRutaId) {
          <div class="map-overlay-message"><mat-spinner diameter="50"></mat-spinner><p>Cargando datos de la ruta #{{selectedRutaId}}...</p></div>
        } @else if (selectedRuta) {
          <app-maps #mapaRecorridos [routes]="mapRoutes" [markers]="mapMarkers" [center]="mapCenter" [zoom]="mapZoom"></app-maps>
          @if(selectedRuta.status && selectedRuta.status.status.toLowerCase() === 'en curso') {
            <button mat-fab color="primary" class="map-fab-button" (click)="centrarEnUltimaPosicion()" matTooltip="Centrar en Vehículo">
              <mat-icon>my_location</mat-icon>
            </button>
          }
        } @else {
          <div class="map-overlay-message"><mat-icon>route</mat-icon><p>Selecciona una ruta de la tabla para ver su información en el mapa.</p></div>
        }
      </div>
    </div>
    <!-- Fin de la sección de mapa y controles -->

    <mat-divider class="section-divider"></mat-divider>

    <!-- ======================================================================= -->
    <!-- === SECCIÓN DE LA TABLA CON EL ESTILO ESTÁNDAR DE LAS OTRAS VISTAS === -->
    <!-- ======================================================================= -->
    <div class="list-card">
        <div class="list-header">
            <div class="list-title">
                <mat-icon>alt_route</mat-icon>
                <h3>Listado de Recorridos</h3>
            </div>
        </div>

        <div class="table-container">
            @if (isLoadingData && !dataSource.data.length) {
                <div class="loading-container">
                    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
                    <p>Cargando recorridos...</p>
                </div>
            } @else {
                <table mat-table [dataSource]="dataSource" matSort>
                    <ng-container matColumnDef="idRuta">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header># RUTA</th>
                        <td mat-cell *matCellDef="let ruta">{{ ruta.idRuta }}</td>
                    </ng-container>
                    
                    <ng-container matColumnDef="operador">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>OPERADOR</th>
                        <td mat-cell *matCellDef="let ruta">{{ ruta.usuario?.usuario }}</td>
                    </ng-container>

                    <ng-container matColumnDef="unidad">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>UNIDAD</th>
                        <td mat-cell *matCellDef="let ruta">{{ ruta.unidadTransporte?.nombreUnidad }}</td>
                    </ng-container>

                    <ng-container matColumnDef="fechaHora">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>FECHA</th>
                        <td mat-cell *matCellDef="let ruta">{{ ruta.fechaHora | date : "dd/MM/yyyy HH:mm" }}</td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>ESTADO</th>
                        <td mat-cell *matCellDef="let ruta">
                            <span class="status-label" [ngClass]="'status-' + getStatusClass(ruta.status)">
                                {{ ruta.status?.status || 'Desconocido' }}
                            </span>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns" 
                        (click)="seleccionarRuta(row)"
                        class="clickable-row" 
                        [class.selected-row]="row.idRuta === selectedRutaId">
                    </tr>
                    <tr class="mat-row" *matNoDataRow><td class="mat-cell" [attr.colspan]="displayedColumns.length">No se encontraron recorridos.</td></tr>
                </table>
            }
        </div>

        @if (!isLoadingData) {
            <mat-paginator [pageSizeOptions]="[10, 25, 100]" showFirstLastButtons aria-label="Seleccionar página"></mat-paginator>
        }
    </div>
  </mat-card-content>
</mat-card>